name: ðŸ”„ CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  # æž„å»ºé…ç½®
  BUILD_TYPE: Release
  VCPKG_ROOT: ${{ github.workspace }}/vcpkg
  
  # Docker é…ç½®
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    runs-on: ubuntu-latest
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ðŸ” C++ ä»£ç æ ¼å¼æ£€æŸ¥
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format-14
        
        echo "æ£€æŸ¥ C++ ä»£ç æ ¼å¼..."
        find include src -name "*.hpp" -o -name "*.cpp" | while read file; do
          if ! clang-format-14 --dry-run --Werror "$file" > /dev/null 2>&1; then
            echo "âŒ æ ¼å¼é”™è¯¯: $file"
            clang-format-14 --dry-run --Werror "$file" 2>&1 || true
            exit 1
          fi
        done
        echo "âœ… C++ ä»£ç æ ¼å¼æ£€æŸ¥é€šè¿‡"
        
    - name: ðŸ” CMake æ ¼å¼æ£€æŸ¥
      run: |
        sudo pip install cmake-format
        
        echo "æ£€æŸ¥ CMake æ–‡ä»¶æ ¼å¼..."
        find . -name "CMakeLists.txt" -o -name "*.cmake" | while read file; do
          if ! cmake-format --check "$file" > /dev/null 2>&1; then
            echo "âŒ CMake æ ¼å¼é”™è¯¯: $file"
            exit 1
          fi
        done
        echo "âœ… CMake æ ¼å¼æ£€æŸ¥é€šè¿‡"

  # æž„å»ºå’Œæµ‹è¯• (Linux)
  build-linux:
    runs-on: ubuntu-latest
    needs: code-quality
    strategy:
      matrix:
        compiler: [gcc-11, clang-14]
        build_type: [Debug, Release]
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: ðŸ”§ å®‰è£…æž„å»ºä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          pkg-config \
          curl \
          zip \
          unzip \
          tar \
          git
          
        # å®‰è£…ç‰¹å®šç¼–è¯‘å™¨
        if [[ "${{ matrix.compiler }}" == "gcc-11" ]]; then
          sudo apt-get install -y gcc-11 g++-11
          echo "CC=gcc-11" >> $GITHUB_ENV
          echo "CXX=g++-11" >> $GITHUB_ENV
        elif [[ "${{ matrix.compiler }}" == "clang-14" ]]; then
          sudo apt-get install -y clang-14
          echo "CC=clang-14" >> $GITHUB_ENV
          echo "CXX=clang++-14" >> $GITHUB_ENV
        fi

    - name: ðŸ“¦ ç¼“å­˜ vcpkg
      uses: actions/cache@v3
      with:
        path: |
          ${{ env.VCPKG_ROOT }}
          !${{ env.VCPKG_ROOT }}/buildtrees
          !${{ env.VCPKG_ROOT }}/packages
          !${{ env.VCPKG_ROOT }}/downloads
        key: vcpkg-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}
        restore-keys: |
          vcpkg-${{ runner.os }}-

    - name: ðŸ› ï¸ å®‰è£… vcpkg
      run: |
        if [ ! -d "$VCPKG_ROOT" ]; then
          git clone https://github.com/Microsoft/vcpkg.git $VCPKG_ROOT
        fi
        cd $VCPKG_ROOT
        ./bootstrap-vcpkg.sh
        ./vcpkg integrate install

    - name: ðŸ—ï¸ é…ç½®æž„å»º
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
          -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake \
          -DSHIELD_BUILD_TESTS=ON \
          -DSHIELD_BUILD_EXAMPLES=ON \
          -G Ninja

    - name: ðŸ”¨ ç¼–è¯‘é¡¹ç›®
      run: |
        cmake --build build --config ${{ matrix.build_type }} --parallel $(nproc)

    - name: ðŸ§ª è¿è¡Œæµ‹è¯•
      run: |
        cd build
        ctest --output-on-failure --parallel $(nproc)

    - name: ðŸ“Š æµ‹è¯•è¦†ç›–çŽ‡ (ä»… Debug + GCC)
      if: matrix.build_type == 'Debug' && matrix.compiler == 'gcc-11'
      run: |
        sudo apt-get install -y gcovr
        gcovr --root . --exclude-directories build/vcpkg_installed --xml-pretty --xml coverage.xml
        
    - name: ðŸ“¤ ä¸Šä¼ è¦†ç›–çŽ‡æŠ¥å‘Š
      if: matrix.build_type == 'Debug' && matrix.compiler == 'gcc-11'
      uses: codecov/codecov-action@v3
      with:
        files: coverage.xml
        fail_ci_if_error: false

  # æž„å»ºå’Œæµ‹è¯• (macOS)
  build-macos:
    runs-on: macos-latest
    needs: code-quality
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: ðŸ”§ å®‰è£…æž„å»ºä¾èµ–
      run: |
        brew install cmake ninja pkg-config

    - name: ðŸ“¦ ç¼“å­˜ vcpkg
      uses: actions/cache@v3
      with:
        path: |
          ${{ env.VCPKG_ROOT }}
          !${{ env.VCPKG_ROOT }}/buildtrees
          !${{ env.VCPKG_ROOT }}/packages
          !${{ env.VCPKG_ROOT }}/downloads
        key: vcpkg-macos-${{ hashFiles('vcpkg.json') }}

    - name: ðŸ› ï¸ å®‰è£… vcpkg
      run: |
        git clone https://github.com/Microsoft/vcpkg.git $VCPKG_ROOT
        cd $VCPKG_ROOT
        ./bootstrap-vcpkg.sh

    - name: ðŸ—ï¸ é…ç½®å’Œç¼–è¯‘
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake \
          -DSHIELD_BUILD_TESTS=ON \
          -G Ninja
        cmake --build build --parallel $(sysctl -n hw.logicalcpu)

    - name: ðŸ§ª è¿è¡Œæµ‹è¯•
      run: |
        cd build
        ctest --output-on-failure --parallel $(sysctl -n hw.logicalcpu)

  # Docker é•œåƒæž„å»º
  build-docker:
    runs-on: ubuntu-latest
    needs: [build-linux]
    if: github.event_name == 'push'
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ðŸ”§ è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ðŸ”‘ ç™»å½•å®¹å™¨æ³¨å†Œè¡¨
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ðŸ“Š æå–å…ƒæ•°æ®
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha
          type=raw,value=latest,enable={{is_default_branch}}

    - name: ðŸ—ï¸ æž„å»ºå’ŒæŽ¨é€ Docker é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BUILD_TYPE=Release
          ENABLE_OPTIMIZATIONS=ON

  # å®‰å…¨æ‰«æ
  security-scan:
    runs-on: ubuntu-latest
    needs: [build-docker]
    if: github.event_name == 'push'
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ðŸ” ä»£ç å®‰å…¨æ‰«æ
      uses: github/codeql-action/init@v3
      with:
        languages: cpp

    - name: ðŸ—ï¸ æž„å»ºé¡¹ç›® (CodeQL)
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake ninja-build
        
        git clone https://github.com/Microsoft/vcpkg.git vcpkg
        cd vcpkg && ./bootstrap-vcpkg.sh && cd ..
        
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_TOOLCHAIN_FILE=vcpkg/scripts/buildsystems/vcpkg.cmake \
          -G Ninja
        cmake --build build --parallel 2

    - name: ðŸ” æ‰§è¡Œ CodeQL åˆ†æž
      uses: github/codeql-action/analyze@v3

    - name: ðŸ³ Docker é•œåƒå®‰å…¨æ‰«æ
      if: github.event_name == 'push'
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: ðŸ“¤ ä¸Šä¼ å®‰å…¨æ‰«æç»“æžœ
      if: github.event_name == 'push'
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-results.sarif'

  # æ€§èƒ½åŸºå‡†æµ‹è¯•
  benchmark:
    runs-on: ubuntu-latest
    needs: [build-linux]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # éœ€è¦åŽ†å²è®°å½•æ¥æ¯”è¾ƒæ€§èƒ½

    - name: ðŸ”§ å®‰è£…ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake ninja-build

    - name: ðŸ—ï¸ æž„å»ºåŸºå‡†æµ‹è¯•
      run: |
        git clone https://github.com/Microsoft/vcpkg.git vcpkg
        cd vcpkg && ./bootstrap-vcpkg.sh && cd ..
        
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_TOOLCHAIN_FILE=vcpkg/scripts/buildsystems/vcpkg.cmake \
          -DSHIELD_BUILD_BENCHMARKS=ON \
          -G Ninja
        cmake --build build --target benchmarks --parallel $(nproc)

    - name: ðŸƒ è¿è¡ŒåŸºå‡†æµ‹è¯•
      run: |
        cd build
        ./benchmarks/shield_benchmarks --benchmark_format=json > benchmark_results.json

    - name: ðŸ“Š ä¸Šä¼ åŸºå‡†æµ‹è¯•ç»“æžœ
      uses: benchmark-action/github-action-benchmark@v1
      with:
        tool: 'googlecpp'
        output-file-path: build/benchmark_results.json
        github-token: ${{ secrets.GITHUB_TOKEN }}
        auto-push: true
        comment-on-alert: true
        alert-threshold: '200%'
        fail-on-alert: false