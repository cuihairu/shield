name: ğŸ“š æ„å»ºå’Œéƒ¨ç½²æ–‡æ¡£

on:
  push:
    branches: [ main ]
    paths: 
      - 'docs/**'
      - 'book.toml'
      - '.github/workflows/docs.yml'
  pull_request:
    branches: [ main ]
    paths: 
      - 'docs/**'
      - 'book.toml'

# è®¾ç½®æƒé™ä»¥ä¾¿éƒ¨ç½²åˆ° GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# ç¡®ä¿åŒæ—¶åªæœ‰ä¸€ä¸ªéƒ¨ç½²ä»»åŠ¡è¿è¡Œ
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  # æ„å»ºæ–‡æ¡£
  build:
    runs-on: ubuntu-latest
    env:
      MDBOOK_VERSION: 0.4.36
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ’¾ å®‰è£… mdBook
      run: |
        curl --proto '=https' --tlsv1.2 https://sh.rustup.rs -sSf -y | sh
        rustup update
        cargo install --version ${MDBOOK_VERSION} mdbook
        
    - name: ğŸ”§ å®‰è£… mdBook æ’ä»¶
      run: |
        cargo install mdbook-mermaid
        cargo install mdbook-toc
        cargo install mdbook-linkcheck

    - name: ğŸ”§ é…ç½® GitHub Pages
      id: pages
      uses: actions/configure-pages@v4

    - name: ğŸ“– æ„å»ºæ–‡æ¡£
      run: |
        echo "æ„å»º mdBook æ–‡æ¡£..."
        mdbook build
        
        # æ£€æŸ¥æ„å»ºç»“æœ
        if [ ! -d "book" ] || [ ! -f "book/index.html" ]; then
          echo "âŒ æ–‡æ¡£æ„å»ºå¤±è´¥"
          exit 1
        fi
        
        echo "âœ… æ–‡æ¡£æ„å»ºæˆåŠŸ"
        echo "ğŸ“Š æ„å»ºç»Ÿè®¡:"
        find book -name "*.html" | wc -l | xargs echo "HTML æ–‡ä»¶æ•°é‡:"
        du -sh book | cut -f1 | xargs echo "æ€»å¤§å°:"

    - name: ğŸ” é“¾æ¥æ£€æŸ¥
      run: |
        echo "æ£€æŸ¥æ–‡æ¡£é“¾æ¥..."
        mdbook test
        
    - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./book

  # éƒ¨ç½²åˆ° GitHub Pages (ä»…ä¸»åˆ†æ”¯)
  deploy:
    if: github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
    - name: ğŸš€ éƒ¨ç½²åˆ° GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: ğŸ“ éƒ¨ç½²ç»“æœé€šçŸ¥
      run: |
        echo "ğŸ‰ æ–‡æ¡£éƒ¨ç½²æˆåŠŸ!"
        echo "ğŸ“ è®¿é—®åœ°å€: ${{ steps.deployment.outputs.page_url }}"

  # æ–‡æ¡£è´¨é‡æ£€æŸ¥
  quality-check:
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ” æ£€æŸ¥ Markdown æ ¼å¼
      uses: DavidAnson/markdownlint-action@v1
      with:
        files: 'docs/**/*.md'
        config: '.markdownlint.json'
        ignore: 'docs/SUMMARY.md'

    - name: ğŸ“ æ£€æŸ¥æ–‡æ¡£ç»“æ„
      run: |
        echo "æ£€æŸ¥å¿…è¦æ–‡æ¡£æ˜¯å¦å­˜åœ¨..."
        
        required_files=(
          "docs/README.md"
          "docs/SUMMARY.md"
          "docs/quickstart.md"
          "docs/architecture.md"
          "docs/development-guide.md"
          "docs/configuration.md"
          "docs/roadmap.md"
        )
        
        missing_files=()
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            missing_files+=("$file")
          fi
        done
        
        if [ ${#missing_files[@]} -gt 0 ]; then
          echo "âŒ ç¼ºå°‘ä»¥ä¸‹å¿…è¦æ–‡æ¡£:"
          printf '  - %s\n' "${missing_files[@]}"
          exit 1
        fi
        
        echo "âœ… æ–‡æ¡£ç»“æ„æ£€æŸ¥é€šè¿‡"

    - name: ğŸ“Š æ–‡æ¡£ç»Ÿè®¡
      run: |
        echo "ğŸ“Š æ–‡æ¡£ç»Ÿè®¡ä¿¡æ¯:"
        echo "æ€»æ–‡æ¡£æ•°é‡: $(find docs -name "*.md" | wc -l)"
        echo "æ€»å­—æ•°: $(find docs -name "*.md" -exec wc -w {} + | tail -1 | awk '{print $1}')"
        echo "æ€»è¡Œæ•°: $(find docs -name "*.md" -exec wc -l {} + | tail -1 | awk '{print $1}')"
        
        echo ""
        echo "ğŸ“ å„ç›®å½•æ–‡æ¡£æ•°é‡:"
        find docs -name "*.md" | xargs dirname | sort | uniq -c | sort -nr

  # PR é¢„è§ˆ (ä»… PR æ—¶è§¦å‘)
  preview:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    env:
      MDBOOK_VERSION: 0.4.36
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ’¾ å®‰è£… mdBook
      run: |
        curl --proto '=https' --tlsv1.2 https://sh.rustup.rs -sSf -y | sh
        rustup update
        cargo install --version ${MDBOOK_VERSION} mdbook

    - name: ğŸ“– æ„å»ºé¢„è§ˆç‰ˆæ–‡æ¡£
      run: |
        mdbook build
        echo "ğŸ“– PR é¢„è§ˆç‰ˆæ–‡æ¡£æ„å»ºå®Œæˆ"

    - name: ğŸ“¤ ä¸Šä¼ é¢„è§ˆäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: docs-preview
        path: ./book
        retention-days: 7

    - name: ğŸ’¬ PR è¯„è®º
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo, number } = context.issue;
          
          // æŸ¥æ‰¾æ˜¯å¦å·²æœ‰é¢„è§ˆè¯„è®º
          const comments = await github.rest.issues.listComments({
            owner,
            repo,
            issue_number: number,
          });
          
          const botComment = comments.data.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('ğŸ“– æ–‡æ¡£é¢„è§ˆ')
          );
          
          const commentBody = `## ğŸ“– æ–‡æ¡£é¢„è§ˆ
          
          âœ… PR æ–‡æ¡£é¢„è§ˆå·²æ„å»ºå®Œæˆï¼
          
          **æ„å»ºä¿¡æ¯:**
          - æ„å»ºæ—¶é—´: ${new Date().toLocaleString('zh-CN')}
          - æäº¤: ${context.sha.substring(0, 7)}
          - åˆ†æ”¯: ${context.payload.pull_request.head.ref}
          
          **ä¸‹è½½é¢„è§ˆ:**
          å¯ä»¥åœ¨ [Actions](https://github.com/${owner}/${repo}/actions/runs/${context.runId}) é¡µé¢ä¸‹è½½ \`docs-preview\` äº§ç‰©æŸ¥çœ‹å®Œæ•´æ–‡æ¡£ã€‚
          
          ---
          *æ­¤è¯„è®ºç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*`;
          
          if (botComment) {
            // æ›´æ–°ç°æœ‰è¯„è®º
            await github.rest.issues.updateComment({
              owner,
              repo,
              comment_id: botComment.id,
              body: commentBody
            });
          } else {
            // åˆ›å»ºæ–°è¯„è®º
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: number,
              body: commentBody
            });
          }